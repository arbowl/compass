{% extends "base.html" %}

{% block title %}Settings - {{ user.name }}{% endblock %}

{% block content %}
<div class="settings-header">
    <h2>Settings ⚙️</h2>
    <p class="subtitle">Customize which metrics you track</p>
</div>

<div class="settings-section">
    <h3>Enabled Metrics</h3>
    <p class="section-description">Toggle metrics on/off. Only enabled metrics appear in your daily dashboard.</p>
    
    <div class="metrics-toggle-list">
        {% for metric in all_metrics %}
        <div class="metric-toggle-item">
            <div class="metric-info">
                <h4>{{ metric.display_name }}</h4>
                <p class="metric-description">{{ metric.description }}</p>
            </div>
            <label class="toggle-switch">
                <input 
                    type="checkbox" 
                    data-metric="{{ metric.name }}"
                    {% if metric.name in enabled_metric_names %}checked{% endif %}
                    onchange="toggleMetric({{ user.id }}, '{{ metric.name }}', this.checked)"
                >
                <span class="toggle-slider"></span>
            </label>
        </div>
        {% endfor %}
    </div>
</div>

<div class="settings-section">
    <h3>User Information</h3>
    <div class="user-info-card">
        <p><strong>Name:</strong> {{ user.name }}</p>
        <p><strong>Created:</strong> {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</p>
        <p><strong>User ID:</strong> {{ user.id }}</p>
    </div>
</div>

<div class="back-link">
    <a href="{{ url_for('user_dashboard', user_id=user.id) }}" class="btn btn-secondary">← Back to Dashboard</a>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleMetric(userId, metricName, enabled) {
    const formData = new FormData();
    formData.append('metric_name', metricName);
    formData.append('enabled', enabled);
    
    fetch(`/user/${userId}/settings/toggle`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Metric ${enabled ? 'enabled' : 'disabled'}`, 'success');
        } else {
            showMessage('Error updating metric', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error updating metric', 'error');
    });
}

function showMessage(text, category) {
    const messagesDiv = document.querySelector('.messages') || createMessagesDiv();
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${category}`;
    messageDiv.innerHTML = `
        ${text}
        <button class="message-close" onclick="this.parentElement.remove()">×</button>
    `;
    messagesDiv.appendChild(messageDiv);
    
    setTimeout(() => messageDiv.remove(), 3000);
}

function createMessagesDiv() {
    const div = document.createElement('div');
    div.className = 'messages';
    document.querySelector('main').insertBefore(div, document.querySelector('main').firstChild);
    return div;
}
</script>
{% endblock %}