{% extends "base.html" %}

{% block title %}Trends - {{ user.name }}{% endblock %}

{% block content %}
<div class="trends-header">
    <h2>Your Trends üìä</h2>
    <div class="time-range-selector">
        <a href="?days=7" class="time-btn {% if days == 7 %}active{% endif %}">7 Days</a>
        <a href="?days=30" class="time-btn {% if days == 30 %}active{% endif %}">30 Days</a>
        <a href="?days=90" class="time-btn {% if days == 90 %}active{% endif %}">90 Days</a>
    </div>
</div>

{% if metric_data %}
    <div class="metrics-trends">
        {% for data in metric_data %}
        <div class="trend-card">
            <div class="trend-header">
                <h3>{{ data.metric.display_name }}</h3>
                <span class="trend-type-badge">{{ data.trends.trend_type }}</span>
            </div>
            
            <div class="trend-summary">
                <p class="summary-text">{{ data.aggregates.summary }}</p>
            </div>
            
            {% if data.aggregates.stats.count > 0 %}
            <div class="trend-stats">
                <h4>Statistics</h4>
                <div class="stats-grid">
                    {% for key, value in data.aggregates.stats.items() %}
                        {% if key != "count" %}
                        <div class="stat-item">
                            <span class="stat-label">{{ key|replace("_", " "|title) }}:</span>
                            <span class="stat-value">
                                {% if value is number %}
                                    {{ value }}
                                {% elif value is boolean %}
                                    {{ "Yes" if value else "No" }}
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <div class="trend-data">
                <h4>Data Points ({{ data.trends.data_points|length }})</h4>
                
                {% if data.trends.trend_type == "line" %}
                    <div class="data-visualization line-chart">
                        {% for point in data.trends.data_points[-10:] %}
                        <div class="data-point">
                            <span class="point-date">{{ point.date }}</span>
                            <span class="point-value">{{ point.value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                
                {% elif data.trends.trend_type == "calendar" %}
                    <div class="data-visualization calendar-view">
                        {% for point in data.trends.data_points[-14:] %}
                        <div class="calendar-day {% if point.value %}day-active{% else %}day-inactive{% endif %}">
                            <span class="day-date">{{ point.date[-5:] }}</span>
                            <span class="day-status">{{ "‚úì" if point.value else "‚Äì" }}</span>
                        </div>
                        {% endfor %}
                    </div>
                
                {% elif data.trends.trend_type == "text" %}
                    <div class="data-visualization text-timeline">
                        {% for point in data.trends.data_points[-5:] %}
                        <div class="timeline-item">
                            <span class="timeline-date">{{ point.date }}</span>
                            <p class="timeline-text">{{ point.preview }}</p>
                        </div>
                        {% endfor %}
                    </div>
                
                {% else %}
                    <div class="data-visualization generic-list">
                        {% for point in data.trends.data_points[-10:] %}
                        <div class="data-point">
                            <span class="point-date">{{ point.date }}</span>
                            <span class="point-value">{{ point.value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>No data for this time period</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <p>No metrics to display. Start logging to see trends!</p>
    </div>
{% endif %}

<div class="back-link">
    <a href="{{ url_for('user_dashboard', user_id=user.id) }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<div class="llm-qa-section">
    <h3>Ask About Your Trends </h3>
    <p class="section-description">Have questions about your data?</p>
    
    <div class="llm-qa-form">
        <input 
            type="text" 
            id="llm-question" 
            placeholder="e.g., How's my exercise pattern compared to last month?"
            class="input-field"
        >
        <button onclick="askLLM('{{ user.id }}')" class="btn btn-primary">Ask</button>
    </div>
    
    <div id="llm-answer" class="llm-answer hidden"></div>
    <div id="llm-loading" class="llm-loading hidden">Thinking...</div>
    <div id="llm-error" class="llm-error hidden"></div>
    </div>
    
    <script>
    async function askLLM(userId) {
    const question = document.getElementById('llm-question').value.trim();
    if (!question) {
        return;
    }
    const answerDiv = document.getElementById('llm-answer');
    const loadingDiv = document.getElementById('llm-loading');
    const errorDiv = document.getElementById('llm-error');
    try {
        const response = await fetch(`/user/${userId}/llm/ask`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question })
        });
        const data = await response.json();
        loadingDiv.classList.add('hidden');
        if (response.ok) {
            answerDiv.textContent = data.answer;
            answerDiv.classList.remove('hidden');
        } else {
            errorDiv.textContent = data.error || 'Error getting response';
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        loadingDiv.classList.add('hidden');
        errorDiv.textContent = error.message || 'Error getting response';
        errorDiv.classList.remove('hidden');
    }
}
</script>
{% endblock %}